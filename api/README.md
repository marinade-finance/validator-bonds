# Validator Bonds API

Validator Bonds API provides access to on-chain data about validator bonds stored in a database.

The module contains the `store` CLI tool to populate the database from a YAML file generated by the `bonds-collector` tool.

## Develoment

### Starting Develoment PostgreSQL with Docker

```bash
export DB='validator-bonds'
docker run --name postgresql-${DB} -p 5444:5432 --rm \
  -e POSTGRES_DB=${DB} \
  -e POSTGRES_USER=${DB} \
  -e POSTGRES_PASSWORD=${DB} \
  postgres:17.4 \
  -c max-prepared-transactions=100 \
  -c log-statement=all \
  -c ssl=on \
  -c ssl_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem \
  -c ssl_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

export DB='validator-bonds'
for FILE in ./migrations/*.sql; do
  echo "Migration SQL init execution: $FILE"
  PGPASSWORD=${DB} psql -U ${DB} -d ${DB} \
    -h localhost -p 5444 -f "$FILE"
done

export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
docker cp postgresql-${DB}:/etc/ssl/certs/ssl-cert-snakeoil.pem "$PG_SSLROOTCERT"
```

### Storing bonds data to the database

```bash
export DB='validator-bonds'
export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
export POSTGRES_URL="postgresql://${DB}:${DB}@localhost:5444/${DB}"
cargo run --bin validator-bonds-api-cli -- store-bonds \
    --input-file bonds.yaml \
    --postgres-ssl-root-cert "$PG_SSLROOTCERT" \
    --postgres-url "$POSTGRES_URL"
```

### Accessing API

```bash
# Start the API server
export DB='validator-bonds'
export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
export POSTGRES_URL="postgresql://${DB}:${DB}@localhost:5444/${DB}"
cargo run --bin api -- --postgres-url "$POSTGRES_URL" \
  --postgres-ssl-root-cert "$PG_SSLROOTCERT"

# data is gzipped so we use curl --compressed
curl -X GET --compressed "http://localhost:8000/bonds/bidding"
```
