# Engine to generate protected event Settlements for Bidding

## Usage

### 1. Gathering input data

```bash
# Download input files from Google Storage
epoch=652
bucket=marinade-validator-bonds-mainnet
# generated by @marinade-finance/validator-bonds/snapshot-parser-cli
gcloud storage cp "gs://$bucket/$epoch/stakes.json" "stakes.json"

# Download input files from Github
result_number=... # e.g. 17265, verify at https://github.com/marinade-finance/ds-sam-pipeline/tree/main/auctions
curl https://raw.githubusercontent.com/marinade-finance/ds-sam-pipeline/refs/heads/main/auctions/${epoch}.${result_number}/outputs/results.json | jq '.auctionData.stakeAmounts as $s | .auctionData.validators | map(. + .auctionStake + { metadata: { scoringId: "0", delegationStrategyMndeVotes: 0, scoringConfig: "{}", tvl: $s }, maxStakeWanted: (.maxStakeWanted + 0), effectiveBid: (.revShare.auctionEffectiveBidPmpe + 0), constraints: (.lastCapConstraints.constraintType|tostring), scoringRunId: 0, epoch: '$epoch'})' > sam-scores.json

# Or from the scoring api
curl scoring.marinade.finance/api/v1/scores/sam?epoch=${epoch} > sam-scores.json

```

### 2. Generating Bidding Settlements

```bash
# See prepare-bid-distribution.yaml
export WHITELIST_STAKE_AUTHORITY='stWirqFCf2Uts1JBL1Jsd3r6VBWhgnpdPxCTe1MFjrq,4bZ6o3eUUNXhKuqjdCnCoPAoLgWiuLYixKaxoa8PpiKk,ex9CfkBZZd6Nv9XdnoDmmB45ymbu4arXVk7g5pWnt3N'

# Build & run
cargo run --release --bin bid-distribution-cli -- \
    --sam-meta-collection sam-scores.json \
    --stake-meta-collection stakes.json \
    --marinade-fee-bps 950 \
    --marinade-fee-stake-authority BBaQsiRo744NAYaqL3nKRfgeJayoqVicEQsEnLpfsJ6x \
    --marinade-fee-withdraw-authority BBaQsiRo744NAYaqL3nKRfgeJayoqVicEQsEnLpfsJ6x \
    --dao-fee-split-share-bps 5000 \
    --dao-fee-stake-authority mDAo14E6YJfEHcVZLcc235RVjviypmKMhftq7jeiLJz \
    --dao-fee-withdraw-authority mDAo14E6YJfEHcVZLcc235RVjviypmKMhftq7jeiLJz \
    --output-settlement-collection bid-distribution-settlements.json \
    --output-merkle-tree-collection bid-distribution-settlement-merkle-trees.json
```
