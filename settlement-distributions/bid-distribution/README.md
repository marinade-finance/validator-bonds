# Engine to generate protected event Settlements for Bidding

## Usage

### 1. Gathering input data

```bash
# Download input files from Google Storage
epoch=652
bucket=marinade-validator-bonds-mainnet
# generated by @marinade-finance/validator-bonds/snapshot-parser-cli
gcloud storage cp "gs://$bucket/$epoch/stakes.json" "stakes.json"

# Download input files from Github
curl https://raw.githubusercontent.com/marinade-finance/ds-sam-pipeline/refs/heads/main/auctions/${epoch}.17265/outputs/results.json | jq '.auctionData.stakeAmounts as $s | .auctionData.validators | map(. + .auctionStake + { metadata: { scoringId: "0", delegationStrategyMndeVotes: 0, scoringConfig: "{}", tvl: $s }, maxStakeWanted: (.maxStakeWanted + 0), effectiveBid: (.revShare.auctionEffectiveBidPmpe + 0), constraints: (.lastCapConstraints.constraintType|tostring), scoringRunId: 0, epoch: '$epoch'})' > sam-scores.json

# Or from the scoring api
curl scoring.marinade.finance/api/v1/scores/sam?epoch=${epoch} > sam-scores.json

```

### 2. Generating Bidding Settlements

```bash
# Build & run
cargo run --release --bin bid-distribution-cli -- \
    --sam-meta-collection sam-scores.json \
    --stake-meta-collection stakes.json \
    --marinade-fee-bps 5000 \
    --marinade-fee-stake-authority 89SrbjbuNyqSqAALKBsKBqMSh463eLvzS4iVWCeArBgB \
    --marinade-fee-withdraw-authority 89SrbjbuNyqSqAALKBsKBqMSh463eLvzS4iVWCeArBgB \
    --dao-fee-split-share-bps 5000 \
    --dao-fee-stake-authority 89SrbjbuNyqSqAALKBsKBqMSh463eLvzS4iVWCeArBgB \
    --dao-fee-withdraw-authority 89SrbjbuNyqSqAALKBsKBqMSh463eLvzS4iVWCeArBgB \
    --output-settlement-collection bid-distribution-settlements.json \
    --output-merkle-tree-collection bid-distribution-settlement-merkle-trees.json
```
