# Engine to generate protected event Settlements for Bidding

## Usage

### 1. Gathering input data

```bash
# Download input files from Google Storage
epoch=883
bucket=marinade-validator-bonds-mainnet
pipeline_dir="/tmp/bond-pipeline-${epoch}" && mkdir -p "$pipeline_dir"

# generated by @marinade-finance/validator-bonds/snapshot-parser-cli
gcloud storage cp "gs://$bucket/$epoch/stakes.json" "${pipeline_dir}/stakes.json"

# Input data comes from ds-sam-pipeline
curl scoring.marinade.finance/api/v1/scores/sam?epoch=${epoch} > "${pipeline_dir}/sam-scores.json"

# Rewards input data from stakes-etl
rewards_dir="${pipeline_dir}/rewards"
mkdir -p "$rewards_dir"
gs_bucket_etl='gs://marinade-stakes-etl-mainnet'
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_mev.json" "$rewards_dir"/mev.json
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_validators_mev.json" "$rewards_dir"/validators_mev.json
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_inflation.json" "$rewards_dir"/inflation.json
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_validators_inflation.json" "$rewards_dir"/validators_inflation.json
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_validators_blocks.json" "$rewards_dir"/validators_blocks.json
gcloud storage cp "$gs_bucket_etl/$epoch/rewards_priority_fee.json" "$rewards_dir"/jito_priority_fee.json
```

### 2. Generating Bidding Settlements

```bash
# See prepare-bid-distribution.yaml
export WHITELIST_STAKE_AUTHORITY='stWirqFCf2Uts1JBL1Jsd3r6VBWhgnpdPxCTe1MFjrq,4bZ6o3eUUNXhKuqjdCnCoPAoLgWiuLYixKaxoa8PpiKk,ex9CfkBZZd6Nv9XdnoDmmB45ymbu4arXVk7g5pWnt3N'

# Build & run
cargo run --release --bin bid-distribution-cli -- \
    --sam-meta-collection "${pipeline_dir}/sam-scores.json" \
    --stake-meta-collection "${pipeline_dir}/stakes.json" \
    --rewards-dir "$rewards_dir" \
    --marinade-fee-bps 950 \
    --marinade-fee-stake-authority BBaQsiRo744NAYaqL3nKRfgeJayoqVicEQsEnLpfsJ6x \
    --marinade-fee-withdraw-authority BBaQsiRo744NAYaqL3nKRfgeJayoqVicEQsEnLpfsJ6x \
    --dao-fee-split-share-bps 5000 \
    --dao-fee-stake-authority mDAo14E6YJfEHcVZLcc235RVjviypmKMhftq7jeiLJz \
    --dao-fee-withdraw-authority mDAo14E6YJfEHcVZLcc235RVjviypmKMhftq7jeiLJz \
    --output-settlement-collection "${pipeline_dir}/bid-distribution-settlements.json" \
    --output-merkle-tree-collection "${pipeline_dir}/bid-distribution-settlement-merkle-trees.json"
```
