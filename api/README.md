# Validator Bonds API

Validator Bonds API provides access to on-chain data about validator bonds stored in a database.

The module contains the `store` CLI tool to populate the database from a YAML file generated by the `bonds-collector` tool.

## Develoment

### Starting Develoment PostgreSQL with Docker

```bash
export DB='validator-bonds'
docker run --name postgresql-${DB} -p 5444:5432 --rm \
  -e POSTGRES_DB=${DB} \
  -e POSTGRES_USER=${DB} \
  -e POSTGRES_PASSWORD=${DB} \
  postgres:17.4 \
  -c max-prepared-transactions=100 \
  -c log-statement=all \
  -c ssl=on \
  -c ssl_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem \
  -c ssl_key_file=/etc/ssl/private/ssl-cert-snakeoil.key

export DB='validator-bonds'
for FILE in ./migrations/*.sql; do
  echo "Migration SQL init execution: $FILE"
  PGPASSWORD=${DB} psql -U ${DB} -d ${DB} \
    -h localhost -p 5444 -f "$FILE"
done

export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
docker cp postgresql-${DB}:/etc/ssl/certs/ssl-cert-snakeoil.pem "$PG_SSLROOTCERT"
```

### Storing bonds data to the database

```bash
export DB='validator-bonds'
export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
export POSTGRES_URL="postgresql://${DB}:${DB}@localhost:5444/${DB}"
cargo run --bin validator-bonds-api-cli -- store-bonds \
    --input-file bonds.yaml \
    --postgres-ssl-root-cert "$PG_SSLROOTCERT" \
    --postgres-url "$POSTGRES_URL"
```

### Accessing API

```bash
# Start the API server
export DB='validator-bonds'
export PG_SSLROOTCERT="/tmp/${DB}-postgres-root-cert.pem"
export POSTGRES_URL="postgresql://${DB}:${DB}@localhost:5444/${DB}"
cargo run --bin api -- --postgres-url "$POSTGRES_URL" \
  --postgres-ssl-root-cert "$PG_SSLROOTCERT"

# data is gzipped so we use curl --compressed
curl -X GET --compressed "http://localhost:8000/bonds/bidding"
```

### Adding CLI announcements

The [validator bonds CLI](../packages/validator-bonds-cli-core/) announces information from the API.
The announcements are loaded from the DB table `cli_announcements`.

To add a new announcement that replaces the previously announced information,
do the SQL INSERT in the following way:

```sql
INSERT INTO cli_announcements (group_id, group_order, title, text, enabled, type_filter)
VALUES (
    (SELECT COALESCE(MAX(group_id), 0) + 1 FROM cli_announcements),
    0,
    'Your Title Here ✓✓✓',
    E'Your announcement text here.\nSecond line if needed.',
    TRUE,
    'sam'
);
```

To check the latest group (possibly shown when type and operation filters are not considered)
and an update that can be used:

```sql
SELECT * FROM cli_announcements
WHERE group_id = (SELECT COALESCE(MAX(group_id), 0) FROM cli_announcements);

UPDATE cli_announcements
SET title = '✓✓✓ Your Title Here ✓✓✓',
    text = E'Your announcement text here.\nSecond line if needed.\n\nAnd more info here.',
    updated_at = NOW()
WHERE id = <<loaded_id>>;
```

There is also a possibility to add multiple announcements and filter them by operation type. See the available DB columns in [cli announcements sql](../migrations/0005-add-cli-announcements.sql).

To check what is shown in the CLI, run:

NOTE: For CLI installation, [see the doc](../packages/validator-bonds-cli/README.md#npm-installation-details).

```sh
validator-bonds -u "$RPC_URL" show-bond
```
